@page "/buchungen"
@using AusgleichslisteApp.Models
@using AusgleichslisteApp.Services
@inject IDataService DataService
@inject ISettlementService SettlementService
@inject IJSRuntime JSRuntime
@inject ISettingsService SettingsService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Buchungen verwalten - @SettingsService.Settings.Branding.ApplicationName</PageTitle>

<div class="container-xxl">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                Buchungen verwalten
            </h1>
        </div>
    </div>
    
    <!-- Such- und Filterbereich -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        Suchen & Filtern
                    </h6>
                    <button class="btn btn-outline-light btn-sm" @onclick="ToggleSearchPanel">
                        @if (showSearchPanel)
                        {
                            <span>Zuklappen</span>
                        }
                        else
                        {
                            <span>Erweitern</span>
                        }
                    </button>
                </div>
                @if (showSearchPanel)
                {
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Textsuche -->
                            <div class="col-md-4">
                                <label class="form-label">Text suchen</label>
                                <input type="text" class="form-control" @bind="searchText" @oninput="OnSearchChanged" placeholder="Artikel/Beschreibung..." />
                            </div>
                            
                            <!-- Zahler Filter -->
                            <div class="col-md-2">
                                <label class="form-label">Zahler</label>
                                <select class="form-select" @bind="filterPayerId" @bind:after="OnFilterChanged">
                                    <option value="">Alle Zahler</option>
                                    @if (users != null)
                                    {
                                        @foreach (var user in users)
                                        {
                                            <option value="@user.Id">@user.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <!-- Empfänger Filter -->
                            <div class="col-md-2">
                                <label class="form-label">Empfänger</label>
                                <select class="form-select" @bind="filterBeneficiaryId" @bind:after="OnFilterChanged">
                                    <option value="">Alle Empfänger</option>
                                    @if (users != null)
                                    {
                                        @foreach (var user in users)
                                        {
                                            <option value="@user.Id">@user.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <!-- Datum Von -->
                            <div class="col-md-2">
                                <label class="form-label">Datum von</label>
                                <input type="date" class="form-control" @bind="filterDateFrom" @bind:after="OnFilterChanged" />
                            </div>
                            
                            <!-- Datum Bis -->
                            <div class="col-md-2">
                                <label class="form-label">Datum bis</label>
                                <input type="date" class="form-control" @bind="filterDateTo" @bind:after="OnFilterChanged" />
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary btn-sm me-2" @onclick="ClearFilters">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                                        <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                                    </svg>
                                    Filter zurücksetzen
                                </button>
                                @if (hasActiveFilters)
                                {
                                    <span class="badge bg-info">Filter aktiv</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    
    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Wird geladen...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Neue Buchung hinzufügen -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            Neue Buchung
                        </h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="newBookingRequest" OnValidSubmit="AddBooking">
                            <div class="mb-3">
                                <label class="form-label">Datum</label>
                                <InputDate @bind-Value="newBookingRequest.Date" class="form-control" />
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Artikel/Beschreibung</label>
                                <InputText @bind-Value="newBookingRequest.Article" class="form-control" placeholder="z.B. Restaurant-Rechnung" />
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Zahler (wer hat bezahlt)</label>
                                <InputSelect @bind-Value="newBookingRequest.PayerId" class="form-select">
                                    <option value="">-- Auswählen --</option>
                                    @if (users != null)
                                    {
                                        @foreach (var user in users.Where(u => u.IsActive).OrderBy(u => u.Name))
                                        {
                                            <option value="@user.Id">@user.Name</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Begünstigter (für wen)</label>
                                <InputSelect @bind-Value="newBookingRequest.BeneficiaryId" class="form-select">
                                    <option value="">-- Auswählen --</option>
                                    @if (users != null)
                                    {
                                        @foreach (var user in users.Where(u => u.IsActive).OrderBy(u => u.Name))
                                        {
                                            <option value="@user.Id">@user.Name</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Betrag (€)</label>
                                <InputNumber @bind-Value="newBookingRequest.Amount" class="form-control" step="0.01" min="0.01" />
                            </div>
                            
                            @if (!string.IsNullOrEmpty(validationMessage))
                            {
                                <div class="alert alert-warning">@validationMessage</div>
                            }
                            
                            <button type="submit" class="btn btn-primary w-100" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Hinzufügen
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>
            
            <!-- Buchungen Liste -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            @if (hasActiveFilters)
                            {
                                <span>Gefilterte Buchungen (@(filteredBookings?.Count ?? 0) von @(allBookings?.Count ?? 0))</span>
                            }
                            else
                            {
                                <span>Alle Buchungen (@(filteredBookings?.Count ?? 0))</span>
                            }
                        </h5>
                        <div>
                            <button class="btn btn-outline-light btn-sm me-2" @onclick="ToggleDeleted">
                                @if (showDeleted)
                                {
                                    @("Gelöschte verbergen")
                                }
                                else
                                {
                                    @("Gelöschte anzeigen")
                                }
                            </button>
                            <button class="btn btn-outline-light btn-sm" @onclick="ToggleFilter">
                                @if (showOnlySettlements)
                                {
                                    @("Alle anzeigen")
                                }
                                else
                                {
                                    @("Nur Ausgleiche")
                                }
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (filteredBookings?.Any() == true)
                        {
                            var displayBookings = showOnlySettlements ? 
                                filteredBookings.Where(b => b.IsSettlement).ToList() : filteredBookings.ToList();
                            
                            var sortedBookings = displayBookings.OrderByDescending(b => b.Date).ThenByDescending(b => b.CreatedAt).ToList();
                            var totalItems = sortedBookings.Count;
                            var totalPages = (int)Math.Ceiling((double)totalItems / itemsPerPage);
                            var pagedBookings = sortedBookings.Skip((currentPage - 1) * itemsPerPage).Take(itemsPerPage);
                            
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Datum</th>
                                            <th>Artikel</th>
                                            <th>Zahler</th>
                                            <th>Für</th>
                                            <th>Betrag</th>
                                            <th>Typ</th>
                                            <th>Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var booking in pagedBookings)
                                        {
                                            <tr class="@(booking.IsDeleted ? "table-secondary" : "")" style="@(booking.IsDeleted ? "text-decoration: line-through; opacity: 0.6;" : "")">
                                                <td>
                                                    <small>@booking.Date.ToString("dd.MM.yyyy")</small>
                                                    @if (booking.IsDeleted)
                                                    {
                                                        <br><small class="text-muted">Gelöscht: @booking.DeletedAt?.ToString("dd.MM.yyyy HH:mm")</small>
                                                    }
                                                </td>
                                                <td>
                                                    <span title="@booking.Article">
                                                        @(booking.Article.Length > 20 ? booking.Article[..17] + "..." : booking.Article)
                                                    </span>
                                                </td>
                                                <td>
                                                    <strong>@(booking.Payer?.Name ?? booking.PayerId)</strong>
                                                </td>
                                                <td>
                                                    <strong>@(booking.Beneficiary?.Name ?? booking.BeneficiaryId)</strong>
                                                </td>
                                                <td>
                                                    <strong>@booking.Amount.ToString("F2") €</strong>
                                                </td>
                                                <td>
                                                    @if (booking.IsDeleted)
                                                    {
                                                        <span class="text-muted">
                                                            Gelöscht
                                                        </span>
                                                    }
                                                    else if (booking.IsSettlement)
                                                    {
                                                        <span class="text-muted">
                                                            Ausgleich
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-dark">
                                                            Buchung
                                                        </span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (!booking.IsDeleted)
                                                    {
                                                        <button class="btn btn-link text-danger p-1" 
                                                                @onclick="() => ConfirmDeleteBooking(booking)" 
                                                                disabled="@isProcessing"
                                                                title="Buchung löschen"
                                                                style="border: none; background: none;">
                                                            @if (isProcessing && bookingToDelete?.Id == booking.Id)
                                                            {
                                                                <span class="spinner-border spinner-border-sm"></span>
                                                            }
                                                            else
                                                            {
                                                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                                                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                                                                </svg>
                                                            }
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted small">Gelöscht</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            @if (totalPages > 1)
                            {
                                <nav aria-label="Buchungen Navigation">
                                    <ul class="pagination justify-content-center mt-3">
                                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                                                Zurück
                                            </button>
                                        </li>
                                        
                                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                        {
                                            var pageNum = i;
                                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                                <button class="page-link" @onclick="() => GoToPage(pageNum)">
                                                    @pageNum
                                                </button>
                                            </li>
                                        }
                                        
                                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                                                Weiter
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <div class="text-center text-muted small">
                                        Seite @currentPage von @totalPages (@totalItems Buchungen)
                                    </div>
                                </nav>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <p class="text-muted">Noch keine Buchungen vorhanden.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show">
                @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
            </div>
        }
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }
    }

@code {
    private List<User>? users;
    private List<Booking>? allBookings = new(); // Alle Buchungen ungefiltert
    private List<Booking>? filteredBookings = new(); // Gefilterte Buchungen
    private AddBookingRequest newBookingRequest = new();
    private bool isLoading = true;
    private bool isProcessing = false;
    private bool showOnlySettlements = false;
    private bool showDeleted = false; // Flag für Anzeige gelöschter Buchungen
    private string validationMessage = string.Empty;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private Booking? bookingToDelete;
    
    // Such- und Filtervariablen
    private bool showSearchPanel = false;
    private string searchText = string.Empty;
    private string filterPayerId = string.Empty;
    private string filterBeneficiaryId = string.Empty;
    private DateTime? filterDateFrom = null;
    private DateTime? filterDateTo = null;
    private System.Timers.Timer? searchTimer;
    
    // Pagination
    private int currentPage = 1;
    private int itemsPerPage = 100;
    
    // Such- und Filterfunktionalität
    private bool hasActiveFilters => !string.IsNullOrWhiteSpace(searchText) ||
                                   !string.IsNullOrWhiteSpace(filterPayerId) ||
                                   !string.IsNullOrWhiteSpace(filterBeneficiaryId) ||
                                   filterDateFrom.HasValue ||
                                   filterDateTo.HasValue;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            users = await DataService.GetUsersAsync();
            // Lade Buchungen basierend auf showDeleted Flag
            if (showDeleted)
            {
                allBookings = await DataService.GetAllBookingsIncludingDeletedAsync();
            }
            else
            {
                allBookings = await DataService.GetBookingsAsync();
            }
            
            // Setze Navigation Properties für bessere Anzeige
            var userMap = users.ToDictionary(u => u.Id, u => u);
            foreach (var booking in allBookings)
            {
                booking.Payer = userMap.GetValueOrDefault(booking.PayerId);
                booking.Beneficiary = userMap.GetValueOrDefault(booking.BeneficiaryId);
            }
            
            // Wende Filter an
            await ApplyFilters();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Laden der Daten: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task AddBooking()
    {
        validationMessage = string.Empty;
        errorMessage = string.Empty;
        
        if (!newBookingRequest.IsValid())
        {
            validationMessage = "Bitte alle Felder korrekt ausfüllen. Zahler und Begünstigter müssen unterschiedlich sein.";
            return;
        }
        
        isProcessing = true;
        StateHasChanged();
        
        try
        {
            var booking = new Booking(
                payerId: newBookingRequest.PayerId,
                beneficiaryId: newBookingRequest.BeneficiaryId,
                amount: newBookingRequest.Amount,
                article: newBookingRequest.Article,
                date: newBookingRequest.Date
            );
            
            await DataService.AddBookingAsync(booking);
            await LoadData();
            
            // Reset form
            newBookingRequest = new AddBookingRequest { Date = DateTime.Now };
            successMessage = $"Buchung '{booking.Article}' wurde erfolgreich hinzugefügt.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Hinzufügen der Buchung: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }
    
    private async Task ConfirmDeleteBooking(Booking booking)
    {
        if (booking == null) return;
        
        var payerName = booking.Payer?.Name ?? booking.PayerId;
        var beneficiaryName = booking.Beneficiary?.Name ?? booking.BeneficiaryId;
        var confirmMessage = $"Buchung wirklich löschen?\n\n" +
                           $"Datum: {booking.Date:dd.MM.yyyy}\n" +
                           $"Artikel: {booking.Article}\n" +
                           $"Von: {payerName}\n" +
                           $"Für: {beneficiaryName}\n" +
                           $"Betrag: {booking.Amount:F2} €\n\n" +
                           $"Diese Aktion kann nicht rückgängig gemacht werden.";
        
        // JavaScript confirm Dialog
        var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./Components/Pages/Bookings.razor.js");
        var confirmed = await module.InvokeAsync<bool>("confirmDelete", confirmMessage);
        
        if (confirmed)
        {
            await DeleteBooking(booking);
        }
    }
    
    private async Task DeleteBooking(Booking booking)
    {
        if (booking == null) return;
        
        bookingToDelete = booking;
        isProcessing = true;
        StateHasChanged();
        
        try
        {
            await DataService.DeleteBookingAsync(booking.Id);
            await LoadData();
            successMessage = $"Buchung '{booking.Article}' wurde gelöscht.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Löschen der Buchung: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            bookingToDelete = null;
            StateHasChanged();
        }
    }
    
    private async Task ToggleDeleted()
    {
        showDeleted = !showDeleted;
        currentPage = 1; // Reset to first page when toggling
        await LoadData(); // Reload data to include/exclude deleted bookings
    }
    
    private void ToggleFilter()
    {
        showOnlySettlements = !showOnlySettlements;
        currentPage = 1; // Reset to first page when filtering
        StateHasChanged();
    }
    
    private void GoToPage(int page)
    {
        currentPage = page;
        StateHasChanged();
    }
    
    private void ToggleSearchPanel()
    {
        showSearchPanel = !showSearchPanel;
        StateHasChanged();
    }
    
    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? string.Empty;
        
        // Debounce: Warte 500ms nach der letzten Eingabe
        searchTimer?.Stop();
        searchTimer = new System.Timers.Timer(500);
        searchTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(async () =>
            {
                await ApplyFilters();
                StateHasChanged();
            });
        };
        searchTimer.AutoReset = false;
        searchTimer.Start();
    }
    
    private async Task OnFilterChanged()
    {
        currentPage = 1; // Reset to first page when filtering
        await ApplyFilters();
        StateHasChanged();
    }
    
    private async Task ApplyFilters()
    {
        if (allBookings == null || !allBookings.Any())
        {
            filteredBookings = new List<Booking>();
            return;
        }
        
        var query = allBookings.AsQueryable();
        
        // Textsuche in Article
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var searchLower = searchText.ToLower();
            query = query.Where(b => b.Article.ToLower().Contains(searchLower));
        }
        
        // Filter nach Zahler
        if (!string.IsNullOrWhiteSpace(filterPayerId))
        {
            query = query.Where(b => b.PayerId == filterPayerId);
        }
        
        // Filter nach Empfänger
        if (!string.IsNullOrWhiteSpace(filterBeneficiaryId))
        {
            query = query.Where(b => b.BeneficiaryId == filterBeneficiaryId);
        }
        
        // Filter nach Datum von
        if (filterDateFrom.HasValue)
        {
            query = query.Where(b => b.Date.Date >= filterDateFrom.Value.Date);
        }
        
        // Filter nach Datum bis
        if (filterDateTo.HasValue)
        {
            query = query.Where(b => b.Date.Date <= filterDateTo.Value.Date);
        }
        
        filteredBookings = query.ToList();
    }
    
    private async Task ClearFilters()
    {
        searchText = string.Empty;
        filterPayerId = string.Empty;
        filterBeneficiaryId = string.Empty;
        filterDateFrom = null;
        filterDateTo = null;
        currentPage = 1;
        
        await ApplyFilters();
        StateHasChanged();
    }
    
    public void Dispose()
    {
        searchTimer?.Stop();
        searchTimer?.Dispose();
    }
}
</div>