@page "/user/{UserId}/payment"
@using AusgleichslisteApp.Models
@using AusgleichslisteApp.Services
@inject IDataService DataService
@inject ISettlementService SettlementService
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Zahlungsinformationen - @SettingsService.Settings.Branding.ApplicationName</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-12">
            <a href="/" class="btn btn-outline-primary btn-sm mb-3">
                ← Zurück zum Dashboard
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Wird geladen...</span>
            </div>
        </div>
    }
    else if (user == null)
    {
        <div class="alert alert-danger">
            Benutzer nicht gefunden.
        </div>
    }
    else
    {
        <div class="row">
            <!-- Benutzerinformationen und Zahlungsdaten -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">@user.Name</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="mb-4">Zahlungsinformationen</h5>

                        @if (editingPayment)
                        {
                            <EditForm Model="paymentModel" OnValidSubmit="SavePaymentInfo">
                                <div class="mb-3">
                                    <label class="form-label">PayPal Adresse</label>
                                    <input type="email" class="form-control" 
                                           @bind="paymentModel.PayPalAddress" 
                                           placeholder="z.B. max.mustermann@gmail.com"
                                           disabled="@isProcessing" />
                                    <small class="text-muted">Optional</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Wero (SEPA instant)</label>
                                    <input type="text" class="form-control" 
                                           @bind="paymentModel.WeroAddress" 
                                           placeholder="z.B. Telefonnummer"
                                           disabled="@isProcessing" />
                                    <small class="text-muted">Optional</small>
                                </div>

                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="alert alert-danger">@errorMessage</div>
                                }

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                        @if (isProcessing)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        Speichern
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit" disabled="@isProcessing">
                                        Abbrechen
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">PayPal Adresse</label>
                                @if (!string.IsNullOrEmpty(user.PayPalAddress))
                                {
                                    <div class="text-monospace bg-light p-2 rounded mb-2">@user.PayPalAddress</div>
                                }
                                else
                                {
                                    <p class="text-muted">Nicht hinterlegt</p>
                                }
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">Wero (SEPA instant)</label>
                                @if (!string.IsNullOrEmpty(user.WeroAddress))
                                {
                                    <div class="text-monospace bg-light p-2 rounded mb-2">@user.WeroAddress</div>
                                }
                                else
                                {
                                    <p class="text-muted">Nicht hinterlegt</p>
                                }
                            </div>

                            <button class="btn btn-outline-primary" @onclick="StartEdit" disabled="@isProcessing">
                                ✏️ Bearbeiten
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Schulden Übersicht -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Schulden</h5>
                    </div>
                    <div class="card-body">
                        @if (debts?.Any() == true)
                        {
                            <div class="list-group">
                                @foreach (var debt in debts)
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">@debt.CreditorName</h6>
                                                <small class="text-muted">@debt.Details</small>
                                            </div>
                                            <div class="text-end">
                                                <div class="mb-2">
                                                    <span class="badge bg-danger">@debt.Amount.ToString("F2") €</span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        @onclick="() => CreateSettlement(debt)"
                                                        disabled="@isProcessing"
                                                        title="Ausgleichsbuchung erstellen">
                                                    ✓ Zahlen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-success">✓ Keine offenen Schulden</p>
                        }
                    </div>
                </div>

                <!-- Guthaben Übersicht -->
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Guthaben</h5>
                    </div>
                    <div class="card-body">
                        @if (credits?.Any() == true)
                        {
                            <div class="list-group">
                                @foreach (var credit in credits)
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@credit.DebtorName</h6>
                                                <small class="text-muted">@credit.Details</small>
                                            </div>
                                            <span class="badge bg-success">@credit.Amount.ToString("F2") €</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Keine Guthaben</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal für Ausgleichsbuchung -->
        @if (showSettlementModal && selectedDebt != null)
        {
            <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ausgleichsbuchung erstellen</h5>
                            <button type="button" class="btn-close" @onclick="CloseSettlementModal" disabled="@isProcessing"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-3">
                                <strong>@user?.Name</strong> zahlt an <strong>@selectedDebt.CreditorName</strong>
                            </p>
                            
                            <div class="mb-3">
                                <label class="form-label">Betrag (€)</label>
                                <input type="text" class="form-control" 
                                       @bind="settlementAmount" 
                                       @bind:event="oninput"
                                       @onblur="() => CalculateSettlementAmount()"
                                       placeholder="z.B. 50 oder 100/2"
                                       disabled="@isProcessing" />
                                @if (!string.IsNullOrEmpty(settlementError))
                                {
                                    <small class="text-danger d-block mt-1">@settlementError</small>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(settlementModalError))
                            {
                                <div class="alert alert-danger">@settlementModalError</div>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseSettlementModal" disabled="@isProcessing">
                                Abbrechen
                            </button>
                            <button type="button" class="btn btn-primary" @onclick="ConfirmSettlement" disabled="@(isProcessing || settlementActualAmount <= 0)">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Ausgleich erstellen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public string? UserId { get; set; }

    private User? user;
    private List<DebtInfo> debts = new();
    private List<CreditInfo> credits = new();
    private bool isLoading = true;
    private bool isProcessing = false;
    private bool editingPayment = false;
    private PaymentModel paymentModel = new();
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            if (string.IsNullOrEmpty(UserId))
            {
                return;
            }

            user = await DataService.GetUserByIdAsync(UserId);
            if (user == null)
            {
                return;
            }

            // Lade Schulden und Guthaben
            await LoadDebtsAndCredits();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Laden der Daten: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadDebtsAndCredits()
    {
        if (user == null || string.IsNullOrEmpty(user.Id))
            return;

        try
        {
            var allBookings = await DataService.GetBookingsAsync();
            debts.Clear();
            credits.Clear();

            var normalBookings = allBookings.Where(b => !b.IsSettlement).ToList();
            var settlementBookings = allBookings.Where(b => b.IsSettlement).ToList();

            var userBookings = normalBookings.Where(b => b.BeneficiaryId == user.Id).ToList();
            var userPayments = normalBookings.Where(b => b.PayerId == user.Id).ToList();

            // Schulden: Normale Buchungen minus eigene Ausgleichszahlungen an den Zahler
            var debtsByPayer = userBookings
                .GroupBy(b => new { b.PayerId, b.Payer?.Name })
                .Select(g =>
                {
                    var settlementAmount = settlementBookings
                        .Where(s => s.PayerId == user.Id && s.BeneficiaryId == g.Key.PayerId)
                        .Sum(s => s.Amount);
                    var settlementCount = settlementBookings
                        .Count(s => s.PayerId == user.Id && s.BeneficiaryId == g.Key.PayerId);
                    var amount = g.Sum(b => b.Amount) - settlementAmount;
                    var details = settlementCount > 0
                        ? $"{g.Count()} Buchung(en), {settlementCount} Ausgleich(e)"
                        : $"{g.Count()} Buchung(en)";

                    return new DebtInfo
                    {
                        CreditorId = g.Key.PayerId,
                        CreditorName = g.Key.Name ?? g.Key.PayerId,
                        Amount = amount,
                        Details = details
                    };
                })
                .Where(d => d.Amount > 0.005m)
                .OrderByDescending(d => d.Amount)
                .ToList();

            debts = debtsByPayer;

            // Guthaben: Normale Buchungen minus Ausgleichszahlungen der Schuldner an den Benutzer
            var creditsByBeneficiary = userPayments
                .GroupBy(b => new { b.BeneficiaryId, b.Beneficiary?.Name })
                .Select(g =>
                {
                    var settlementAmount = settlementBookings
                        .Where(s => s.PayerId == g.Key.BeneficiaryId && s.BeneficiaryId == user.Id)
                        .Sum(s => s.Amount);
                    var settlementCount = settlementBookings
                        .Count(s => s.PayerId == g.Key.BeneficiaryId && s.BeneficiaryId == user.Id);
                    var amount = g.Sum(b => b.Amount) - settlementAmount;
                    var details = settlementCount > 0
                        ? $"{g.Count()} Buchung(en), {settlementCount} Ausgleich(e)"
                        : $"{g.Count()} Buchung(en)";

                    return new CreditInfo
                    {
                        DebtorId = g.Key.BeneficiaryId,
                        DebtorName = g.Key.Name ?? g.Key.BeneficiaryId,
                        Amount = amount,
                        Details = details
                    };
                })
                .Where(c => c.Amount > 0.005m)
                .OrderByDescending(c => c.Amount)
                .ToList();

            credits = creditsByBeneficiary;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Laden der Schulden: {ex.Message}";
        }
    }

    private void StartEdit()
    {
        if (user == null) return;
        
        paymentModel.PayPalAddress = user.PayPalAddress ?? string.Empty;
        paymentModel.WeroAddress = user.WeroAddress ?? string.Empty;
        editingPayment = true;
        errorMessage = string.Empty;
    }

    private void CancelEdit()
    {
        editingPayment = false;
        errorMessage = string.Empty;
    }

    private async Task SavePaymentInfo()
    {
        if (user == null) return;

        isProcessing = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            user.PayPalAddress = string.IsNullOrWhiteSpace(paymentModel.PayPalAddress) 
                ? null 
                : paymentModel.PayPalAddress.Trim();
            
            user.WeroAddress = string.IsNullOrWhiteSpace(paymentModel.WeroAddress) 
                ? null 
                : paymentModel.WeroAddress.Trim();

            await DataService.UpdateUserAsync(user);
            
            editingPayment = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Speichern: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    // Settlement Modal Variables
    private bool showSettlementModal = false;
    private DebtInfo? selectedDebt = null;
    private string settlementAmount = string.Empty;
    private decimal settlementActualAmount = 0;
    private string settlementError = string.Empty;
    private string settlementModalError = string.Empty;

    private void CreateSettlement(DebtInfo debt)
    {
        selectedDebt = debt;
        settlementAmount = debt.Amount.ToString("F2");
        settlementActualAmount = debt.Amount;
        settlementError = string.Empty;
        settlementModalError = string.Empty;
        showSettlementModal = true;
        StateHasChanged();
    }

    private void CloseSettlementModal()
    {
        showSettlementModal = false;
        selectedDebt = null;
        settlementAmount = string.Empty;
        settlementActualAmount = 0;
        settlementError = string.Empty;
        settlementModalError = string.Empty;
    }

    private void CalculateSettlementAmount()
    {
        settlementError = string.Empty;

        if (string.IsNullOrWhiteSpace(settlementAmount) || selectedDebt == null)
        {
            settlementActualAmount = 0;
            return;
        }

        // Versuche zu berechnen (unterstützt Ausdrücke wie 100/2)
        if (decimal.TryParse(settlementAmount.Replace(",", "."), out var result))
        {
            if (result > 0)
            {
                settlementActualAmount = Math.Round(result, 2);
            }
            else
            {
                settlementError = "Betrag muss größer als 0 sein.";
                settlementActualAmount = 0;
            }
        }
        else
        {
            settlementError = "Ungültiger Betrag.";
            settlementActualAmount = 0;
        }

        StateHasChanged();
    }

    private async Task ConfirmSettlement()
    {
        if (user == null || selectedDebt == null || settlementActualAmount <= 0)
            return;

        isProcessing = true;
        settlementModalError = string.Empty;
        StateHasChanged();

        try
        {
            var creditorName = selectedDebt.CreditorName ?? "Unbekannt";
            var payerName = user.Name ?? "Du";
            var settlementText = $"Ausgleich {payerName}->{creditorName}";

            var booking = new Booking(
                payerId: user.Id,
                beneficiaryId: selectedDebt.CreditorId,
                amount: settlementActualAmount,
                article: settlementText,
                date: DateTime.Now
            )
            {
                IsSettlement = true
            };

            await DataService.AddBookingAsync(booking);
            await LoadDebtsAndCredits();
            CloseSettlementModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            settlementModalError = $"Fehler beim Erstellen der Ausgleichsbuchung: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private class PaymentModel
    {
        public string PayPalAddress { get; set; } = string.Empty;
        public string WeroAddress { get; set; } = string.Empty;
    }

    private class DebtInfo
    {
        public string CreditorId { get; set; } = string.Empty;
        public string CreditorName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public string Details { get; set; } = string.Empty;
    }

    private class CreditInfo
    {
        public string DebtorId { get; set; } = string.Empty;
        public string DebtorName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public string Details { get; set; } = string.Empty;
    }
}
